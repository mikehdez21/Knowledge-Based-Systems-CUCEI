
;;Define a rule for finding those customers who have not bought nothing at all... so far

(defrule cust-not-buying
     (customer (customer-id ?id) (name ?name))
     (not (order (order-number ?order) (customer-id ?id)))
   =>
   (printout t ?name " no ha comprado... nada!" crlf))


;;Define a rule for finding which products have been bought

(defrule prods-bought
   (order (order-number ?order))
   (line-item (order-number ?order) (part-number ?part))
   (product (part-number ?part) (name ?pn))
   =>
   (printout t ?pn " was bought " crlf))


;;Define a rule for finding which products have been bought AND their quantity

(defrule prods-qty-bgt
   (order (order-number ?order))
   (line-item (order-number ?order) (part-number ?part) (quantity ?q))
   (product (part-number ?part) (name ?p) )
   =>
   (printout t ?q " " ?p " was/were bought " crlf))

;;Define a rule for finding customers and their shopping info

(defrule customer-shopping
   (customer (customer-id ?id) (name ?cn))
   (order (order-number ?order) (customer-id ?id))
   (line-item (order-number ?order) (part-number ?part))
   (product (part-number ?part) (name ?pn))
   =>
   (printout t ?cn " bought  " ?pn crlf))

;;Define a rule for finding those customers who bought more than 5 products

(defrule cust-5-prods
   (customer (customer-id ?id) (name ?cn))
   (order (order-number ?order) (customer-id ?id))
   (line-item (order-number ?order) (part-number ?part) (quantity ?q&:(> ?q 5)))
   (product (part-number ?part) (name ?pn))
   =>
   (printout t ?cn " bought more than 5 products (" ?pn ")" crlf))

;; Define a rule for texting custormers who have not bought ...

(defrule text-cust (customer (customer-id ?cid) (name ?name) (phone ?phone))
                   (not (order (order-number ?order) (customer-id ?cid)))
=>
(assert (text-customer ?name ?phone "tienes 25% desc prox compra"))
(printout t ?name " 3313073905 tienes 25% desc prox compra" ))


;; Define a rule for calling  custormers who have not bought ...
(defrule call-cust (customer (customer-id ?cid) (name ?name) (phone ?phone))
                   (not (order (order-number ?order) (customer-id ?cid)))
=>
(assert (call-customer ?name ?phone "tienes 25% desc prox compra"))
(printout t ?name " 3313073905 tienes 25% desc prox compra" ))



;; CUSTOMER BEHAVIOR


;; Cliente inactivo como estatus inicial
(defrule init-customer-behavior
   (declare (salience 100))
   (customer (customer-id ?id))
   (not (customer-behavior (customer-id ?id)))
   =>
   (assert (customer-behavior 
		(customer-id ?id) 
		(status inactive)
		(total-spent 0.0)
		(total-items 0)
		(preferred-categories))))


;; Gasto total e items por cliente
(defrule compute-spending-and-categories
  (declare (salience 90))
  ?cb <- (customer-behavior 
            (customer-id ?id) 
            (total-spent ?ts&:(numberp ?ts))
            (total-items ?ti&:(integerp ?ti))
            (status ?status)
            (preferred-categories $?cats))
  (line-item (order-number ?order) (part-number ?pn) (customer-id ?id) (quantity ?q&:(integerp ?q)))
  (product (part-number ?pn) (price ?p&:(numberp ?p)) (category ?cat))
  (not (processed-line-item ?order ?pn))
  =>
  (retract ?cb)
  (bind ?new-ts (+ ?ts (* ?q ?p)))
  (bind ?new-ti (+ ?ti ?q))
  (bind ?new-cats (if (member$ ?cat $?cats) then $?cats else (create$ ?cat $?cats)))
  (assert (customer-behavior 
            (customer-id ?id)
            (status ?status)
            (total-spent ?new-ts)
            (total-items ?new-ti)
            (preferred-categories ?new-cats)))
  (assert (processed-line-item ?order ?pn)))


;; Clasificar comportamiento de consumo
(defrule classify-behavior
  (declare (salience 80))
  ?cb <- (customer-behavior 
            (customer-id ?id) 
            (status ?old-status)
            (total-spent ?ts)
	    (total-items ?ti)
            (preferred-categories $?cats))
  =>
  (if (< ?ti 1) then
    (bind ?new-status inactive)
  else if (< ?ti 5) then
    (bind ?new-status occasional)
  else if (< ?ti 20) then
    (bind ?new-status frequent)
  else
    (bind ?new-status bulk))

  ;; Solo actualiza si el status cambiÃ³
  (if (neq ?old-status ?new-status) then
    (retract ?cb)
    (assert (customer-behavior 
              (customer-id ?id)
              (status ?new-status)
	      (total-spent ?ts)
              (total-items ?ti)
              (preferred-categories $?cats)))))


;; Detectar clientes inactivos - Ofrecer descuentos
(defrule reactivation-offer
  (declare (salience 10))
  (customer (customer-id ?id) (name ?name) (phone ?phone))
  (customer-behavior (customer-id ?id) (status inactive))
  (not (recommendation (customer-id ?id) (type reactivation)))
  =>
  (bind ?msg (str-cat ?name " (tel: " ?phone "), Â¡te extraÃ±amos! Ten 25% OFF en tu prÃ³xima compra."))
  (assert (recommendation (customer-id ?id) (type reactivation) (message ?msg)))
  (printout t "ðŸŽ¯ RecomendaciÃ³n: " ?msg crlf))



;; Detectar clientes ocasionales - agredecer cliente
(defrule occasional-buyer-thanks
  (declare (salience 10))
  (customer (customer-id ?id) (name ?name) (phone ?phone))
  (customer-behavior (customer-id ?id) (status occasional))
  (not (recommendation (customer-id ?id) (type occasional)))
  =>
  (bind ?msg (str-cat ?name " (tel: " ?phone "), Â¡Muchas gracias por tus compras!."))
  (assert (recommendation (customer-id ?id) (type occasional) (message ?msg)))
  (printout t "ðŸ’Œ RecomendaciÃ³n: " ?msg crlf))

;; Detectar clientes frecuentes
(defrule frequent-buyer-reward
  (declare (salience 10))
  (customer (customer-id ?id) (name ?name))
  (customer-behavior (customer-id ?id) (status frequent))
  (not (recommendation (customer-id ?id) (type frequent)))
  =>
  (bind ?msg (str-cat "Â¡Hola " ?name "! Eres un cliente frecuente. Â¡Te damos 10% de descuento en tu prÃ³xima compra!"))
  (assert (recommendation (customer-id ?id) (type frequent) (message ?msg)))
  (printout t "â­ RecomendaciÃ³n: " ?name " - Cliente frecuente" crlf))



;; Detectar compradores bulk â†’ upsell
(defrule bulk-buyer-upsell
  (declare (salience 10))
  (customer (customer-id ?id) (name ?name))
  (customer-behavior (customer-id ?id) (status bulk))
  (not (recommendation (customer-id ?id) (type upsell)))
  =>
  (bind ?msg (str-cat "Â¡Hola " ?name "! Por comprar en volumen, te ofrecemos envÃ­o gratis y soporte premium."))
  (assert (recommendation (customer-id ?id) (type upsell) (message ?msg)))
  (printout t "ðŸš€ RecomendaciÃ³n: " ?name " - Upsell para bulk buyer" crlf))



;; Cross-selling por categorÃ­a
(defrule cross-sell-by-category
  (declare (salience 5))
  (customer-behavior (customer-id ?id) (preferred-categories ?cat $?rest))
  (product (category ?cat) (name ?pname) (part-number ?pn1))
  (product (category ?cat) (name ?pname2) (part-number ?pn2&~?pn1))
  (line-item (customer-id ?id) (part-number ?pn1))
  (not (line-item (customer-id ?id) (part-number ?pn2)))
  (not (recommendation (customer-id ?id) (type cross-sell)))
  =>
  (assert (recommendation (customer-id ?id) (type cross-sell)
          (message (str-cat "Â¿Te gustÃ³ " ?pname "? Â¡Prueba tambiÃ©n " ?pname2 " de la misma categorÃ­a (" ?cat ")!"))))
  (printout t "ðŸ’¡ Cross-sell para cliente " ?id ": " ?pname2 crlf))








